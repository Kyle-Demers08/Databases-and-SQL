{
 "cells": [
  {
   "cell_type": "markdown",
   "id": "547ad268-5377-4bf5-bd9d-e16923edba13",
   "metadata": {},
   "source": [
    "## Kyle Demers"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "2aa1260b-f954-4a42-9f39-6d64d94e3624",
   "metadata": {},
   "outputs": [],
   "source": []
  },
  {
   "cell_type": "markdown",
   "id": "1334d1a2-de5c-421a-90f3-2c9c77e8da20",
   "metadata": {},
   "source": [
    "### Final Project, due Dec 20 by midnight\n",
    "\n",
    "**Instructions:**\n",
    "\n",
    "Do not include any code pertaining to creating tables, loading data, or intermediate results where you are testing things (you can do that a different notebook).\n",
    "\n",
    "There may be cases where it will be beneficial (and highly recommended) to create some views - some of the questions build on each other, so you can use views to avoid duplicating the same code/logic over and over again.  In those cases, please do show the code you used to create the view to help us determine partial credit if something goes wrong!\n",
    "\n",
    "For queries that ask about things like \"the most recent month\", have this determined by the SQL.  I.e., do not hardcode things like '2020-10' into your queries"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "id": "8ba08362-ab1c-43a8-83d1-f1aa9296f5e7",
   "metadata": {},
   "outputs": [],
   "source": [
    "import pandas as pd\n",
    "import sqlite3\n",
    "import numpy as np\n",
    "sqlite3.register_adapter(np.int64, lambda val: int(val)) #fix from piazza to turn np ints into normal ints\n",
    "conn = sqlite3.connect('store.db')\n",
    "curs = conn.cursor()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "ace107f7-b13d-4b71-a2aa-ffcbd4b88b66",
   "metadata": {},
   "source": [
    "---\n",
    "1) What are the rules of Tidy Data?  Which normal form does Tidy Data most closely approximate?  What is the primary motivation for normalizing our data like this, i.e.,  What problems does it aim to prevent?\n"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "78c5bb4a-b0d1-4499-907f-78a37fe63370",
   "metadata": {},
   "source": [
    "Rules of Tidy Data\n",
    "1) Each Variable forms a column\n",
    "2) Each observation forms a row\n",
    "3) Each type of observational unit forms a table"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "4ca873b7-f4c8-4c9f-8cd1-00d1cbaf972e",
   "metadata": {},
   "source": [
    "Tidy data most is closely approximated by **3rd Normal Form** "
   ]
  },
  {
   "cell_type": "markdown",
   "id": "1598564b-2365-464a-a630-f7e1eeeed1fa",
   "metadata": {},
   "source": [
    "to prevent redundancy is the primary motivation. Inconsistencies can occur as a result of having unnormalized data. The goal is to have our data free of anomalies. We are trying to prevent anomalies from occuring."
   ]
  },
  {
   "cell_type": "markdown",
   "id": "cd74b9b2-aef3-47d8-a990-1f709e1e4c13",
   "metadata": {},
   "source": [
    "---\n",
    "2) Load the remaining sales files you've been provided into your store database. Once everything is loaded, you should have data for every month from January 2019 to October 2021.\n",
    "\n",
    "Assuming your database and code is setup properly, you should encounter a problem loading one or more of the files.\n",
    "\n",
    "This is not the type of error you need to correct programmatically - you'll want to open the file and correct the issue manually.  I have set things up in such a way that once you find it, it should be clear what to do. (Also, avoid Excel.  Use a basic text editor.  Excel might try to reformat things like zip codes which will lead to other problems). \n",
    "\n",
    "If you are unsure what to do when you find it, you can ask me - but before doing so, make sure you can tell me which file(s) and which row(s) are causing the issue.\n",
    "\n",
    "**When you have found the problem(s), indicate the file name(s), row numbers(s), and paste in the data from that row(s) below.**"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "c20dd249-700f-46fe-8b68-21e8e5e96c94",
   "metadata": {},
   "source": [
    "Problem in SALES_202102.csv. Somebody tried to order 333333333 Levels on row 42. \n",
    "\n",
    "|first|last|addr|city|state|zip|date|prod_id|prod_desc|unit_price|qty|\n",
    "|-----|---|-----|----|-----|---|----|------|-----------|---------|----|\n",
    "|Rieekan|Mccarthy|8944 Canterbury Drive|Dunseith|ND|58329|2021-01-03|317|Level|16.99|3333333333|\n",
    "\n",
    "Problem in Sales_202008.csv. Somebody tried to order 11111111 Ladders on row 40\n",
    "|first|last|addr|city|state|zip|date|prod_id|prod_desc|unit_price|qty|\n",
    "|-----|---|-----|----|-----|---|----|------|-----------|---------|----|\n",
    "|Snap|Pollard|4987 Sycamore Drive|Mc Louth|KS|66054|2020-08-04|327|Ladder|80.0|11111111|\n",
    "\n",
    "For Grading; if it comes out weird here are the actual results:\n",
    "\n",
    "Rieekan, Mccarthy, 8944 Canterbury Drive, Dunseith, ND, 58329, 2021-01-03, 317, Level, 16.99, 3333333333\n",
    "\n",
    "Snap, Pollard, 4987 Sycamore Drive, Mc Louth, KS, 66054, 2020-08-04, 327, Ladder, 80.0, 11111111"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "5a3970d4-c3b8-4a12-8547-ac780bcf8949",
   "metadata": {},
   "source": [
    "---\n",
    "3) Generate a summary, by month and year of how our store is performing.\n",
    "\n",
    "Have your query return the following:\n",
    " - year\n",
    " - month\n",
    " - Sales: total sales for the month (i.e., sum of qty * unit price)\n",
    " - NumOrders: number of orders placed for the month\n",
    " - NumCust: number of _distinct_ customers who made a purchase (i.e. only count the customer at most once per month)\n",
    " - OrdersPerCust: average number of orders per customer (i.e. NumOrders/NumCust)\n",
    " - SalesPerCust: average sales per customer (i.e. Sales/NumCust)\n",
    " - SalesPerOrder: average sales per order (i.e. Sales/NumOrders)\n",
    "\n",
    "Sort the results should by year and month, in ascending order.\n",
    "\n",
    "_Hint: Watch out for integer division!_"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 67,
   "id": "07a20ba5-92ab-4415-b5eb-9296e566d750",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>year</th>\n",
       "      <th>month</th>\n",
       "      <th>Sales</th>\n",
       "      <th>orders</th>\n",
       "      <th>customers</th>\n",
       "      <th>orders per customer</th>\n",
       "      <th>sales per customer</th>\n",
       "      <th>Sales per Order</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>2019</td>\n",
       "      <td>1</td>\n",
       "      <td>68464.61</td>\n",
       "      <td>91</td>\n",
       "      <td>85</td>\n",
       "      <td>1.070588</td>\n",
       "      <td>805.466000</td>\n",
       "      <td>752.358352</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>2019</td>\n",
       "      <td>2</td>\n",
       "      <td>55560.32</td>\n",
       "      <td>80</td>\n",
       "      <td>73</td>\n",
       "      <td>1.095890</td>\n",
       "      <td>761.100274</td>\n",
       "      <td>694.504000</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>2019</td>\n",
       "      <td>3</td>\n",
       "      <td>19191.68</td>\n",
       "      <td>51</td>\n",
       "      <td>49</td>\n",
       "      <td>1.040816</td>\n",
       "      <td>391.666939</td>\n",
       "      <td>376.307451</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>2019</td>\n",
       "      <td>4</td>\n",
       "      <td>20912.07</td>\n",
       "      <td>48</td>\n",
       "      <td>46</td>\n",
       "      <td>1.043478</td>\n",
       "      <td>454.610217</td>\n",
       "      <td>435.668125</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>2019</td>\n",
       "      <td>5</td>\n",
       "      <td>11973.34</td>\n",
       "      <td>50</td>\n",
       "      <td>46</td>\n",
       "      <td>1.086957</td>\n",
       "      <td>260.290000</td>\n",
       "      <td>239.466800</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>5</th>\n",
       "      <td>2019</td>\n",
       "      <td>6</td>\n",
       "      <td>13737.30</td>\n",
       "      <td>43</td>\n",
       "      <td>41</td>\n",
       "      <td>1.048780</td>\n",
       "      <td>335.056098</td>\n",
       "      <td>319.472093</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>6</th>\n",
       "      <td>2019</td>\n",
       "      <td>7</td>\n",
       "      <td>22095.05</td>\n",
       "      <td>45</td>\n",
       "      <td>41</td>\n",
       "      <td>1.097561</td>\n",
       "      <td>538.903659</td>\n",
       "      <td>491.001111</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>7</th>\n",
       "      <td>2019</td>\n",
       "      <td>8</td>\n",
       "      <td>15675.05</td>\n",
       "      <td>51</td>\n",
       "      <td>49</td>\n",
       "      <td>1.040816</td>\n",
       "      <td>319.898980</td>\n",
       "      <td>307.353922</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>8</th>\n",
       "      <td>2019</td>\n",
       "      <td>9</td>\n",
       "      <td>9360.38</td>\n",
       "      <td>40</td>\n",
       "      <td>39</td>\n",
       "      <td>1.025641</td>\n",
       "      <td>240.009744</td>\n",
       "      <td>234.009500</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>9</th>\n",
       "      <td>2019</td>\n",
       "      <td>10</td>\n",
       "      <td>48411.35</td>\n",
       "      <td>58</td>\n",
       "      <td>51</td>\n",
       "      <td>1.137255</td>\n",
       "      <td>949.242157</td>\n",
       "      <td>834.678448</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>10</th>\n",
       "      <td>2019</td>\n",
       "      <td>11</td>\n",
       "      <td>26242.52</td>\n",
       "      <td>60</td>\n",
       "      <td>55</td>\n",
       "      <td>1.090909</td>\n",
       "      <td>477.136727</td>\n",
       "      <td>437.375333</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>11</th>\n",
       "      <td>2019</td>\n",
       "      <td>12</td>\n",
       "      <td>17120.21</td>\n",
       "      <td>59</td>\n",
       "      <td>50</td>\n",
       "      <td>1.180000</td>\n",
       "      <td>342.404200</td>\n",
       "      <td>290.173051</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>12</th>\n",
       "      <td>2020</td>\n",
       "      <td>1</td>\n",
       "      <td>26483.42</td>\n",
       "      <td>54</td>\n",
       "      <td>52</td>\n",
       "      <td>1.038462</td>\n",
       "      <td>509.296538</td>\n",
       "      <td>490.433704</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>13</th>\n",
       "      <td>2020</td>\n",
       "      <td>2</td>\n",
       "      <td>23473.81</td>\n",
       "      <td>52</td>\n",
       "      <td>48</td>\n",
       "      <td>1.083333</td>\n",
       "      <td>489.037708</td>\n",
       "      <td>451.419423</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>14</th>\n",
       "      <td>2020</td>\n",
       "      <td>3</td>\n",
       "      <td>44350.50</td>\n",
       "      <td>61</td>\n",
       "      <td>56</td>\n",
       "      <td>1.089286</td>\n",
       "      <td>791.973214</td>\n",
       "      <td>727.057377</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>15</th>\n",
       "      <td>2020</td>\n",
       "      <td>4</td>\n",
       "      <td>43669.09</td>\n",
       "      <td>74</td>\n",
       "      <td>67</td>\n",
       "      <td>1.104478</td>\n",
       "      <td>651.777463</td>\n",
       "      <td>590.122838</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>16</th>\n",
       "      <td>2020</td>\n",
       "      <td>5</td>\n",
       "      <td>62960.70</td>\n",
       "      <td>84</td>\n",
       "      <td>75</td>\n",
       "      <td>1.120000</td>\n",
       "      <td>839.476000</td>\n",
       "      <td>749.532143</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>17</th>\n",
       "      <td>2020</td>\n",
       "      <td>6</td>\n",
       "      <td>55861.65</td>\n",
       "      <td>80</td>\n",
       "      <td>70</td>\n",
       "      <td>1.142857</td>\n",
       "      <td>798.023571</td>\n",
       "      <td>698.270625</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>18</th>\n",
       "      <td>2020</td>\n",
       "      <td>7</td>\n",
       "      <td>73209.88</td>\n",
       "      <td>77</td>\n",
       "      <td>65</td>\n",
       "      <td>1.184615</td>\n",
       "      <td>1126.305846</td>\n",
       "      <td>950.777662</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>19</th>\n",
       "      <td>2020</td>\n",
       "      <td>8</td>\n",
       "      <td>105795.72</td>\n",
       "      <td>96</td>\n",
       "      <td>79</td>\n",
       "      <td>1.215190</td>\n",
       "      <td>1339.186329</td>\n",
       "      <td>1102.038750</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>20</th>\n",
       "      <td>2020</td>\n",
       "      <td>9</td>\n",
       "      <td>83470.62</td>\n",
       "      <td>93</td>\n",
       "      <td>85</td>\n",
       "      <td>1.094118</td>\n",
       "      <td>982.007294</td>\n",
       "      <td>897.533548</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>21</th>\n",
       "      <td>2020</td>\n",
       "      <td>10</td>\n",
       "      <td>68566.76</td>\n",
       "      <td>100</td>\n",
       "      <td>91</td>\n",
       "      <td>1.098901</td>\n",
       "      <td>753.480879</td>\n",
       "      <td>685.667600</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>22</th>\n",
       "      <td>2020</td>\n",
       "      <td>11</td>\n",
       "      <td>58551.46</td>\n",
       "      <td>88</td>\n",
       "      <td>81</td>\n",
       "      <td>1.086420</td>\n",
       "      <td>722.857531</td>\n",
       "      <td>665.357500</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>23</th>\n",
       "      <td>2020</td>\n",
       "      <td>12</td>\n",
       "      <td>91301.80</td>\n",
       "      <td>98</td>\n",
       "      <td>85</td>\n",
       "      <td>1.152941</td>\n",
       "      <td>1074.138824</td>\n",
       "      <td>931.651020</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>24</th>\n",
       "      <td>2021</td>\n",
       "      <td>1</td>\n",
       "      <td>104310.14</td>\n",
       "      <td>104</td>\n",
       "      <td>85</td>\n",
       "      <td>1.223529</td>\n",
       "      <td>1227.178118</td>\n",
       "      <td>1002.982115</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>25</th>\n",
       "      <td>2021</td>\n",
       "      <td>2</td>\n",
       "      <td>73437.94</td>\n",
       "      <td>77</td>\n",
       "      <td>66</td>\n",
       "      <td>1.166667</td>\n",
       "      <td>1112.696061</td>\n",
       "      <td>953.739481</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>26</th>\n",
       "      <td>2021</td>\n",
       "      <td>3</td>\n",
       "      <td>107697.80</td>\n",
       "      <td>126</td>\n",
       "      <td>101</td>\n",
       "      <td>1.247525</td>\n",
       "      <td>1066.314851</td>\n",
       "      <td>854.744444</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>27</th>\n",
       "      <td>2021</td>\n",
       "      <td>4</td>\n",
       "      <td>141326.84</td>\n",
       "      <td>140</td>\n",
       "      <td>113</td>\n",
       "      <td>1.238938</td>\n",
       "      <td>1250.680000</td>\n",
       "      <td>1009.477429</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>28</th>\n",
       "      <td>2021</td>\n",
       "      <td>5</td>\n",
       "      <td>154028.29</td>\n",
       "      <td>135</td>\n",
       "      <td>115</td>\n",
       "      <td>1.173913</td>\n",
       "      <td>1339.376435</td>\n",
       "      <td>1140.950296</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>29</th>\n",
       "      <td>2021</td>\n",
       "      <td>6</td>\n",
       "      <td>154172.49</td>\n",
       "      <td>124</td>\n",
       "      <td>98</td>\n",
       "      <td>1.265306</td>\n",
       "      <td>1573.188673</td>\n",
       "      <td>1243.326532</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>30</th>\n",
       "      <td>2021</td>\n",
       "      <td>7</td>\n",
       "      <td>200275.39</td>\n",
       "      <td>154</td>\n",
       "      <td>132</td>\n",
       "      <td>1.166667</td>\n",
       "      <td>1517.237803</td>\n",
       "      <td>1300.489545</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>31</th>\n",
       "      <td>2021</td>\n",
       "      <td>8</td>\n",
       "      <td>215386.24</td>\n",
       "      <td>161</td>\n",
       "      <td>126</td>\n",
       "      <td>1.277778</td>\n",
       "      <td>1709.414603</td>\n",
       "      <td>1337.802733</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>32</th>\n",
       "      <td>2021</td>\n",
       "      <td>9</td>\n",
       "      <td>101263.76</td>\n",
       "      <td>108</td>\n",
       "      <td>92</td>\n",
       "      <td>1.173913</td>\n",
       "      <td>1100.693043</td>\n",
       "      <td>937.627407</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>33</th>\n",
       "      <td>2021</td>\n",
       "      <td>10</td>\n",
       "      <td>251768.12</td>\n",
       "      <td>165</td>\n",
       "      <td>127</td>\n",
       "      <td>1.299213</td>\n",
       "      <td>1982.426142</td>\n",
       "      <td>1525.867394</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "    year  month      Sales  orders  customers  orders per customer  \\\n",
       "0   2019      1   68464.61      91         85             1.070588   \n",
       "1   2019      2   55560.32      80         73             1.095890   \n",
       "2   2019      3   19191.68      51         49             1.040816   \n",
       "3   2019      4   20912.07      48         46             1.043478   \n",
       "4   2019      5   11973.34      50         46             1.086957   \n",
       "5   2019      6   13737.30      43         41             1.048780   \n",
       "6   2019      7   22095.05      45         41             1.097561   \n",
       "7   2019      8   15675.05      51         49             1.040816   \n",
       "8   2019      9    9360.38      40         39             1.025641   \n",
       "9   2019     10   48411.35      58         51             1.137255   \n",
       "10  2019     11   26242.52      60         55             1.090909   \n",
       "11  2019     12   17120.21      59         50             1.180000   \n",
       "12  2020      1   26483.42      54         52             1.038462   \n",
       "13  2020      2   23473.81      52         48             1.083333   \n",
       "14  2020      3   44350.50      61         56             1.089286   \n",
       "15  2020      4   43669.09      74         67             1.104478   \n",
       "16  2020      5   62960.70      84         75             1.120000   \n",
       "17  2020      6   55861.65      80         70             1.142857   \n",
       "18  2020      7   73209.88      77         65             1.184615   \n",
       "19  2020      8  105795.72      96         79             1.215190   \n",
       "20  2020      9   83470.62      93         85             1.094118   \n",
       "21  2020     10   68566.76     100         91             1.098901   \n",
       "22  2020     11   58551.46      88         81             1.086420   \n",
       "23  2020     12   91301.80      98         85             1.152941   \n",
       "24  2021      1  104310.14     104         85             1.223529   \n",
       "25  2021      2   73437.94      77         66             1.166667   \n",
       "26  2021      3  107697.80     126        101             1.247525   \n",
       "27  2021      4  141326.84     140        113             1.238938   \n",
       "28  2021      5  154028.29     135        115             1.173913   \n",
       "29  2021      6  154172.49     124         98             1.265306   \n",
       "30  2021      7  200275.39     154        132             1.166667   \n",
       "31  2021      8  215386.24     161        126             1.277778   \n",
       "32  2021      9  101263.76     108         92             1.173913   \n",
       "33  2021     10  251768.12     165        127             1.299213   \n",
       "\n",
       "    sales per customer  Sales per Order  \n",
       "0           805.466000       752.358352  \n",
       "1           761.100274       694.504000  \n",
       "2           391.666939       376.307451  \n",
       "3           454.610217       435.668125  \n",
       "4           260.290000       239.466800  \n",
       "5           335.056098       319.472093  \n",
       "6           538.903659       491.001111  \n",
       "7           319.898980       307.353922  \n",
       "8           240.009744       234.009500  \n",
       "9           949.242157       834.678448  \n",
       "10          477.136727       437.375333  \n",
       "11          342.404200       290.173051  \n",
       "12          509.296538       490.433704  \n",
       "13          489.037708       451.419423  \n",
       "14          791.973214       727.057377  \n",
       "15          651.777463       590.122838  \n",
       "16          839.476000       749.532143  \n",
       "17          798.023571       698.270625  \n",
       "18         1126.305846       950.777662  \n",
       "19         1339.186329      1102.038750  \n",
       "20          982.007294       897.533548  \n",
       "21          753.480879       685.667600  \n",
       "22          722.857531       665.357500  \n",
       "23         1074.138824       931.651020  \n",
       "24         1227.178118      1002.982115  \n",
       "25         1112.696061       953.739481  \n",
       "26         1066.314851       854.744444  \n",
       "27         1250.680000      1009.477429  \n",
       "28         1339.376435      1140.950296  \n",
       "29         1573.188673      1243.326532  \n",
       "30         1517.237803      1300.489545  \n",
       "31         1709.414603      1337.802733  \n",
       "32         1100.693043       937.627407  \n",
       "33         1982.426142      1525.867394  "
      ]
     },
     "execution_count": 67,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "pd.read_sql('''\n",
    "WITH orders AS\n",
    "(SELECT year, month, count(order_id) as orders, count(DISTINCT (Cust_id)) as customers\n",
    "FROM tOrder\n",
    "GROUP BY year, month\n",
    "),\n",
    "totalsales AS\n",
    "(SELECT year,month, sum(qty*Unit_price) as [Sales], order_id\n",
    "FROM tOrder\n",
    "JOIN tOrderDetail \n",
    "USING (order_id)\n",
    "JOIN tProd\n",
    "USING (Prod_id)\n",
    "GROUP BY year, month\n",
    ")\n",
    "SELECT year, month, [Sales], orders, customers, CAST(orders as Float)/customers as [orders per customer], cast(sales as Float)/customers as [sales per customer], cast(sales as Float)/orders as [Sales per Order]\n",
    "FROM totalsales\n",
    "JOIN orders\n",
    "USING (year,month)\n",
    "GROUP BY year,month\n",
    ";''',conn)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "212acca8-cbeb-4f60-bead-e2cf544cc36f",
   "metadata": {},
   "source": [
    "---\n",
    "4) In which month did we have the lowest total sales?\n",
    "\n",
    "The answer can be confirmed with the previous result, but make sure to write a fresh query for this one, i.e. don't just extract it from the dataframe above!\n",
    "\n",
    "Return one record with:\n",
    "- year\n",
    "- month\n",
    "- sales (sum of qty * unit_price)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 75,
   "id": "b0d0bff9-0581-43aa-9fb9-4573d626207f",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>year</th>\n",
       "      <th>month</th>\n",
       "      <th>Sales</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>2019</td>\n",
       "      <td>9</td>\n",
       "      <td>9360.38</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "   year  month    Sales\n",
       "0  2019      9  9360.38"
      ]
     },
     "execution_count": 75,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "pd.read_sql('''\n",
    "With totalsales AS\n",
    "(SELECT year,month, sum(qty*Unit_price) as [Sales], order_id\n",
    "FROM tOrder\n",
    "JOIN tOrderDetail \n",
    "USING (order_id)\n",
    "JOIN tProd\n",
    "USING (Prod_id)\n",
    "GROUP BY year, month\n",
    ")\n",
    "SELECT year,month, min(Sales) as Sales\n",
    "FROM totalsales\n",
    ";''',conn)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "85321a20-c785-4163-8a5f-81e6d903ee25",
   "metadata": {},
   "source": [
    "---\n",
    "\n",
    "5. In the month determined from the previous question, generate a list of our total sales by state.  Make sure that all states are included, even if they have no sales (50 states + PR and DC = 52 total records).\n",
    "\n",
    "Return:\n",
    "\n",
    "- The two-letter state abbreviation\n",
    "- Total sales for the month in question\n",
    "\n",
    "Order the results so states with no sales are on top."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 139,
   "id": "da47c0fd-519c-47be-af96-049d6a67ed9c",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>st</th>\n",
       "      <th>IFNULL(sales,0)</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>AK</td>\n",
       "      <td>0.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>AR</td>\n",
       "      <td>0.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>AZ</td>\n",
       "      <td>0.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>CO</td>\n",
       "      <td>0.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>CT</td>\n",
       "      <td>0.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>5</th>\n",
       "      <td>DC</td>\n",
       "      <td>0.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>6</th>\n",
       "      <td>DE</td>\n",
       "      <td>0.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>7</th>\n",
       "      <td>MA</td>\n",
       "      <td>0.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>8</th>\n",
       "      <td>ME</td>\n",
       "      <td>0.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>9</th>\n",
       "      <td>MI</td>\n",
       "      <td>0.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>10</th>\n",
       "      <td>NH</td>\n",
       "      <td>0.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>11</th>\n",
       "      <td>NJ</td>\n",
       "      <td>0.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>12</th>\n",
       "      <td>NM</td>\n",
       "      <td>0.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>13</th>\n",
       "      <td>NV</td>\n",
       "      <td>0.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>14</th>\n",
       "      <td>SD</td>\n",
       "      <td>0.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>15</th>\n",
       "      <td>TX</td>\n",
       "      <td>0.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>16</th>\n",
       "      <td>WA</td>\n",
       "      <td>0.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>17</th>\n",
       "      <td>WI</td>\n",
       "      <td>0.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>18</th>\n",
       "      <td>WV</td>\n",
       "      <td>0.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>19</th>\n",
       "      <td>WY</td>\n",
       "      <td>0.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>20</th>\n",
       "      <td>NY</td>\n",
       "      <td>0.25</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>21</th>\n",
       "      <td>MO</td>\n",
       "      <td>1.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>22</th>\n",
       "      <td>ND</td>\n",
       "      <td>1.25</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>23</th>\n",
       "      <td>OK</td>\n",
       "      <td>8.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>24</th>\n",
       "      <td>UT</td>\n",
       "      <td>12.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>25</th>\n",
       "      <td>GA</td>\n",
       "      <td>15.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>26</th>\n",
       "      <td>LA</td>\n",
       "      <td>15.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>27</th>\n",
       "      <td>MT</td>\n",
       "      <td>18.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>28</th>\n",
       "      <td>PA</td>\n",
       "      <td>26.91</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>29</th>\n",
       "      <td>SC</td>\n",
       "      <td>27.99</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>30</th>\n",
       "      <td>AL</td>\n",
       "      <td>28.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>31</th>\n",
       "      <td>KY</td>\n",
       "      <td>37.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>32</th>\n",
       "      <td>IL</td>\n",
       "      <td>58.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>33</th>\n",
       "      <td>HI</td>\n",
       "      <td>65.94</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>34</th>\n",
       "      <td>IN</td>\n",
       "      <td>79.93</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>35</th>\n",
       "      <td>MS</td>\n",
       "      <td>99.02</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>36</th>\n",
       "      <td>ID</td>\n",
       "      <td>110.85</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>37</th>\n",
       "      <td>OR</td>\n",
       "      <td>125.94</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>38</th>\n",
       "      <td>RI</td>\n",
       "      <td>173.27</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>39</th>\n",
       "      <td>KS</td>\n",
       "      <td>198.35</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>40</th>\n",
       "      <td>PR</td>\n",
       "      <td>240.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>41</th>\n",
       "      <td>VT</td>\n",
       "      <td>275.87</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>42</th>\n",
       "      <td>MN</td>\n",
       "      <td>333.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>43</th>\n",
       "      <td>IA</td>\n",
       "      <td>351.84</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>44</th>\n",
       "      <td>VA</td>\n",
       "      <td>365.65</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>45</th>\n",
       "      <td>FL</td>\n",
       "      <td>414.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>46</th>\n",
       "      <td>TN</td>\n",
       "      <td>425.88</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>47</th>\n",
       "      <td>NC</td>\n",
       "      <td>524.62</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>48</th>\n",
       "      <td>CA</td>\n",
       "      <td>557.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>49</th>\n",
       "      <td>OH</td>\n",
       "      <td>822.88</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>50</th>\n",
       "      <td>NE</td>\n",
       "      <td>1422.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>51</th>\n",
       "      <td>MD</td>\n",
       "      <td>2525.94</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "    st  IFNULL(sales,0)\n",
       "0   AK             0.00\n",
       "1   AR             0.00\n",
       "2   AZ             0.00\n",
       "3   CO             0.00\n",
       "4   CT             0.00\n",
       "5   DC             0.00\n",
       "6   DE             0.00\n",
       "7   MA             0.00\n",
       "8   ME             0.00\n",
       "9   MI             0.00\n",
       "10  NH             0.00\n",
       "11  NJ             0.00\n",
       "12  NM             0.00\n",
       "13  NV             0.00\n",
       "14  SD             0.00\n",
       "15  TX             0.00\n",
       "16  WA             0.00\n",
       "17  WI             0.00\n",
       "18  WV             0.00\n",
       "19  WY             0.00\n",
       "20  NY             0.25\n",
       "21  MO             1.00\n",
       "22  ND             1.25\n",
       "23  OK             8.00\n",
       "24  UT            12.00\n",
       "25  GA            15.00\n",
       "26  LA            15.00\n",
       "27  MT            18.00\n",
       "28  PA            26.91\n",
       "29  SC            27.99\n",
       "30  AL            28.00\n",
       "31  KY            37.00\n",
       "32  IL            58.00\n",
       "33  HI            65.94\n",
       "34  IN            79.93\n",
       "35  MS            99.02\n",
       "36  ID           110.85\n",
       "37  OR           125.94\n",
       "38  RI           173.27\n",
       "39  KS           198.35\n",
       "40  PR           240.00\n",
       "41  VT           275.87\n",
       "42  MN           333.00\n",
       "43  IA           351.84\n",
       "44  VA           365.65\n",
       "45  FL           414.00\n",
       "46  TN           425.88\n",
       "47  NC           524.62\n",
       "48  CA           557.00\n",
       "49  OH           822.88\n",
       "50  NE          1422.00\n",
       "51  MD          2525.94"
      ]
     },
     "execution_count": 139,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "pd.read_sql('''\n",
    "WITH SalesState AS\n",
    "(SELECT *, qty*unit_price as sales\n",
    "FROM tOrderDetail\n",
    "JOIN tProd \n",
    "USING(prod_id)\n",
    "JOIN tOrder \n",
    "USING(order_id)\n",
    "JOIN tCust\n",
    "USING(cust_id)\n",
    "JOIN tZip \n",
    "USING(Zip)\n",
    "),\n",
    "totalsales AS\n",
    "(SELECT year,month, sum(qty*Unit_price) as [Sales], order_id\n",
    "FROM tOrder\n",
    "JOIN tOrderDetail \n",
    "USING (order_id)\n",
    "JOIN tProd\n",
    "USING (Prod_id)\n",
    "GROUP BY year, month\n",
    "),\n",
    "minMonth AS\n",
    "(SELECT year,month, min(Sales) as Sales\n",
    "FROM totalsales\n",
    "),\n",
    "Salesmonth AS\n",
    "(SELECT st,year, month, sum(Salesstate.sales) AS sales\n",
    "FROM SalesState\n",
    "JOIN minMonth\n",
    "USING (month, year)\n",
    "GROUP BY st\n",
    ")\n",
    "SELECT st,IFNULL(sales,0)\n",
    "FROM tState\n",
    "FULL JOIN Salesmonth\n",
    "USING(st)\n",
    "ORDER BY SALES\n",
    ";''',conn)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "9f6fb11c-24a5-4015-b8c7-92e0e94cb495",
   "metadata": {},
   "source": [
    "---\n",
    "\n",
    "6. For the list of states above that had $0 sales, generate a list of all the customers in those states, along with how much they have bought from us since then.\n",
    "\n",
    "Return:\n",
    "- customer id\n",
    "- name, address, city, state (abbreviation is fine), and zip code\n",
    "- the customer's total sales from all months after the month from question 4\n",
    "\n",
    "Order the results with the largest sales totals on top."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 168,
   "id": "26b20311-4ffe-44e6-a598-e692b364ef62",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>cust_id</th>\n",
       "      <th>first</th>\n",
       "      <th>last</th>\n",
       "      <th>city</th>\n",
       "      <th>st</th>\n",
       "      <th>zip</th>\n",
       "      <th>addr</th>\n",
       "      <th>Sales</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>17</td>\n",
       "      <td>Rieekan</td>\n",
       "      <td>Gordon</td>\n",
       "      <td>Fort Smith</td>\n",
       "      <td>AR</td>\n",
       "      <td>72916</td>\n",
       "      <td>7641 Park Avenue</td>\n",
       "      <td>21368.34</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>141</td>\n",
       "      <td>Gold Leader</td>\n",
       "      <td>Zhang</td>\n",
       "      <td>Washington</td>\n",
       "      <td>DC</td>\n",
       "      <td>20202</td>\n",
       "      <td>9744 Park Avenue</td>\n",
       "      <td>19391.43</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>88</td>\n",
       "      <td>Gold Leader</td>\n",
       "      <td>Elliott</td>\n",
       "      <td>Victor</td>\n",
       "      <td>WV</td>\n",
       "      <td>25938</td>\n",
       "      <td>9326 Sycamore Street</td>\n",
       "      <td>16796.02</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>173</td>\n",
       "      <td>Plo Koon</td>\n",
       "      <td>Bass</td>\n",
       "      <td>Warner</td>\n",
       "      <td>NH</td>\n",
       "      <td>03278</td>\n",
       "      <td>7380 Heather Lane</td>\n",
       "      <td>16658.30</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>104</td>\n",
       "      <td>Rabe</td>\n",
       "      <td>Vincent</td>\n",
       "      <td>Pattonville</td>\n",
       "      <td>TX</td>\n",
       "      <td>75468</td>\n",
       "      <td>8972 Park Avenue</td>\n",
       "      <td>16273.48</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>...</th>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>113</th>\n",
       "      <td>186</td>\n",
       "      <td>Lieutenant Mitaka</td>\n",
       "      <td>Rivera</td>\n",
       "      <td>Neshanic Station</td>\n",
       "      <td>NJ</td>\n",
       "      <td>08853</td>\n",
       "      <td>7871 Valley Road</td>\n",
       "      <td>1512.37</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>114</th>\n",
       "      <td>38</td>\n",
       "      <td>Padme</td>\n",
       "      <td>Rivera</td>\n",
       "      <td>Bard</td>\n",
       "      <td>NM</td>\n",
       "      <td>88411</td>\n",
       "      <td>5882 Inverness Drive</td>\n",
       "      <td>1485.63</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>115</th>\n",
       "      <td>147</td>\n",
       "      <td>Bib Fortuna</td>\n",
       "      <td>Elliott</td>\n",
       "      <td>Gig Harbor</td>\n",
       "      <td>WA</td>\n",
       "      <td>98335</td>\n",
       "      <td>5364 Heather Lane</td>\n",
       "      <td>1469.19</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>116</th>\n",
       "      <td>306</td>\n",
       "      <td>Darth Maul</td>\n",
       "      <td>Rodriguez</td>\n",
       "      <td>Boothbay</td>\n",
       "      <td>ME</td>\n",
       "      <td>04537</td>\n",
       "      <td>4333 Front Street</td>\n",
       "      <td>443.88</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>117</th>\n",
       "      <td>103</td>\n",
       "      <td>Dodonna</td>\n",
       "      <td>Garza</td>\n",
       "      <td>Tarzan</td>\n",
       "      <td>TX</td>\n",
       "      <td>79783</td>\n",
       "      <td>3639 Briarwood Court</td>\n",
       "      <td>364.90</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>118 rows Ã— 8 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "     cust_id              first       last              city  st    zip  \\\n",
       "0         17            Rieekan     Gordon        Fort Smith  AR  72916   \n",
       "1        141        Gold Leader      Zhang        Washington  DC  20202   \n",
       "2         88        Gold Leader    Elliott            Victor  WV  25938   \n",
       "3        173           Plo Koon       Bass            Warner  NH  03278   \n",
       "4        104               Rabe    Vincent       Pattonville  TX  75468   \n",
       "..       ...                ...        ...               ...  ..    ...   \n",
       "113      186  Lieutenant Mitaka     Rivera  Neshanic Station  NJ  08853   \n",
       "114       38              Padme     Rivera              Bard  NM  88411   \n",
       "115      147        Bib Fortuna    Elliott        Gig Harbor  WA  98335   \n",
       "116      306         Darth Maul  Rodriguez          Boothbay  ME  04537   \n",
       "117      103            Dodonna      Garza            Tarzan  TX  79783   \n",
       "\n",
       "                     addr     Sales  \n",
       "0        7641 Park Avenue  21368.34  \n",
       "1        9744 Park Avenue  19391.43  \n",
       "2    9326 Sycamore Street  16796.02  \n",
       "3       7380 Heather Lane  16658.30  \n",
       "4        8972 Park Avenue  16273.48  \n",
       "..                    ...       ...  \n",
       "113      7871 Valley Road   1512.37  \n",
       "114  5882 Inverness Drive   1485.63  \n",
       "115     5364 Heather Lane   1469.19  \n",
       "116     4333 Front Street    443.88  \n",
       "117  3639 Briarwood Court    364.90  \n",
       "\n",
       "[118 rows x 8 columns]"
      ]
     },
     "execution_count": 168,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "pd.read_sql('''\n",
    "WITH SalesState AS\n",
    "(SELECT *, qty*unit_price as sales\n",
    "FROM tOrderDetail\n",
    "JOIN tProd \n",
    "USING(prod_id)\n",
    "JOIN tOrder \n",
    "USING(order_id)\n",
    "JOIN tCust\n",
    "USING(cust_id)\n",
    "JOIN tZip \n",
    "USING(Zip)\n",
    "),\n",
    "totalsales AS\n",
    "(SELECT year,month, sum(qty*Unit_price) as [Sales], order_id\n",
    "FROM tOrder\n",
    "JOIN tOrderDetail \n",
    "USING (order_id)\n",
    "JOIN tProd\n",
    "USING (Prod_id)\n",
    "GROUP BY year, month\n",
    "),\n",
    "minMonth AS\n",
    "(SELECT year,month, min(Sales) as Sales\n",
    "FROM totalsales\n",
    "),\n",
    "Salesmonth AS\n",
    "(SELECT st,year, month, sum(Salesstate.sales) AS sales\n",
    "FROM SalesState\n",
    "JOIN minMonth\n",
    "USING (month, year)\n",
    "GROUP BY st\n",
    "),\n",
    "StateSale AS\n",
    "(SELECT st, IFNULL (sales,0) as sales\n",
    "FROM tState\n",
    "FULL JOIN Salesmonth\n",
    "USING(st)\n",
    "ORDER BY SALES\n",
    "),\n",
    "NoSales as\n",
    "(SELECT *\n",
    "FROM StateSale\n",
    "WHERE sales = 0\n",
    "),\n",
    "postMin AS\n",
    "(SELECT * \n",
    "FROM SalesState\n",
    "WHERE year > (SELECT year FROM minMonth) \n",
    "\n",
    "UNION \n",
    "\n",
    "SELECT *\n",
    "FROM SalesState\n",
    "WHERE month > (SELECT month FROM minMonth)\n",
    "    AND year = (SELECT year FROM minMonth)\n",
    ")\n",
    "SELECT cust_id,first,last,city,st,zip,addr,sum(postMin.sales) as Sales\n",
    "FROM postMin\n",
    "JOIN NoSales\n",
    "USING(st)\n",
    "GROUP BY cust_id\n",
    "ORDER BY Sales DESC\n",
    ";''',conn)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "bb87300d-d6d3-4272-aedd-f85c48807f45",
   "metadata": {},
   "source": [
    "---\n",
    "\n",
    "7) Get a list of customers who did not purchase anything in the most recent month of data, along with their average sales for all months prior.\n",
    "\n",
    "Return:\n",
    "\n",
    "- customer id\n",
    "- name, address, zip, city, st (abbreviation is fine)\n",
    "- total sales for most recent month (to confirm they are all 0)\n",
    "- average sales for all months prior\n",
    "\n",
    "Order the results with the largest average monthly sales on top."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "id": "8cc666e9-613e-488f-b56d-864b76d90daa",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>cust_id</th>\n",
       "      <th>first</th>\n",
       "      <th>last</th>\n",
       "      <th>addr</th>\n",
       "      <th>zip</th>\n",
       "      <th>st</th>\n",
       "      <th>city</th>\n",
       "      <th>Sales</th>\n",
       "      <th>avgsales</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>246</td>\n",
       "      <td>Unkar Plutt</td>\n",
       "      <td>Woodward</td>\n",
       "      <td>5772 4th Street</td>\n",
       "      <td>51650</td>\n",
       "      <td>IA</td>\n",
       "      <td>Riverton</td>\n",
       "      <td>0</td>\n",
       "      <td>590.661212</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>256</td>\n",
       "      <td>Captain Antilles</td>\n",
       "      <td>Walker</td>\n",
       "      <td>8516 Pheasant Run</td>\n",
       "      <td>20005</td>\n",
       "      <td>DC</td>\n",
       "      <td>Washington</td>\n",
       "      <td>0</td>\n",
       "      <td>561.206667</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>58</td>\n",
       "      <td>Unkar Plutt</td>\n",
       "      <td>Schmidt</td>\n",
       "      <td>9546 Brookside Drive</td>\n",
       "      <td>13623</td>\n",
       "      <td>NY</td>\n",
       "      <td>Chippewa Bay</td>\n",
       "      <td>0</td>\n",
       "      <td>533.290000</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>59</td>\n",
       "      <td>Jobal</td>\n",
       "      <td>Mitchell</td>\n",
       "      <td>1198 West Avenue</td>\n",
       "      <td>38629</td>\n",
       "      <td>MS</td>\n",
       "      <td>Falkner</td>\n",
       "      <td>0</td>\n",
       "      <td>519.972424</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>88</td>\n",
       "      <td>Gold Leader</td>\n",
       "      <td>Elliott</td>\n",
       "      <td>9326 Sycamore Street</td>\n",
       "      <td>25938</td>\n",
       "      <td>WV</td>\n",
       "      <td>Victor</td>\n",
       "      <td>0</td>\n",
       "      <td>509.008182</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>...</th>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>178</th>\n",
       "      <td>264</td>\n",
       "      <td>Mace Windu</td>\n",
       "      <td>Greene</td>\n",
       "      <td>9572 9th Street</td>\n",
       "      <td>61957</td>\n",
       "      <td>IL</td>\n",
       "      <td>Windsor</td>\n",
       "      <td>0</td>\n",
       "      <td>43.382121</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>179</th>\n",
       "      <td>303</td>\n",
       "      <td>Darth Maul</td>\n",
       "      <td>Walters</td>\n",
       "      <td>7851 Magnolia Court</td>\n",
       "      <td>58046</td>\n",
       "      <td>ND</td>\n",
       "      <td>Hope</td>\n",
       "      <td>0</td>\n",
       "      <td>39.101212</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>180</th>\n",
       "      <td>310</td>\n",
       "      <td>Bala-Tik</td>\n",
       "      <td>Zhang</td>\n",
       "      <td>1559 Lake Avenue</td>\n",
       "      <td>93673</td>\n",
       "      <td>CA</td>\n",
       "      <td>Traver</td>\n",
       "      <td>0</td>\n",
       "      <td>36.436364</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>181</th>\n",
       "      <td>309</td>\n",
       "      <td>Clone Commander Cody</td>\n",
       "      <td>Benson</td>\n",
       "      <td>4836 Front Street</td>\n",
       "      <td>28390</td>\n",
       "      <td>NC</td>\n",
       "      <td>Spring Lake</td>\n",
       "      <td>0</td>\n",
       "      <td>25.335152</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>182</th>\n",
       "      <td>306</td>\n",
       "      <td>Darth Maul</td>\n",
       "      <td>Rodriguez</td>\n",
       "      <td>4333 Front Street</td>\n",
       "      <td>04537</td>\n",
       "      <td>ME</td>\n",
       "      <td>Boothbay</td>\n",
       "      <td>0</td>\n",
       "      <td>21.930000</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>183 rows Ã— 9 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "     cust_id                 first       last                  addr    zip  \\\n",
       "0        246           Unkar Plutt   Woodward       5772 4th Street  51650   \n",
       "1        256      Captain Antilles     Walker     8516 Pheasant Run  20005   \n",
       "2         58           Unkar Plutt    Schmidt  9546 Brookside Drive  13623   \n",
       "3         59                 Jobal   Mitchell      1198 West Avenue  38629   \n",
       "4         88           Gold Leader    Elliott  9326 Sycamore Street  25938   \n",
       "..       ...                   ...        ...                   ...    ...   \n",
       "178      264            Mace Windu     Greene       9572 9th Street  61957   \n",
       "179      303            Darth Maul    Walters   7851 Magnolia Court  58046   \n",
       "180      310              Bala-Tik      Zhang      1559 Lake Avenue  93673   \n",
       "181      309  Clone Commander Cody     Benson     4836 Front Street  28390   \n",
       "182      306            Darth Maul  Rodriguez     4333 Front Street  04537   \n",
       "\n",
       "     st          city  Sales    avgsales  \n",
       "0    IA      Riverton      0  590.661212  \n",
       "1    DC    Washington      0  561.206667  \n",
       "2    NY  Chippewa Bay      0  533.290000  \n",
       "3    MS       Falkner      0  519.972424  \n",
       "4    WV        Victor      0  509.008182  \n",
       "..   ..           ...    ...         ...  \n",
       "178  IL       Windsor      0   43.382121  \n",
       "179  ND          Hope      0   39.101212  \n",
       "180  CA        Traver      0   36.436364  \n",
       "181  NC   Spring Lake      0   25.335152  \n",
       "182  ME      Boothbay      0   21.930000  \n",
       "\n",
       "[183 rows x 9 columns]"
      ]
     },
     "execution_count": 4,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "pd.read_sql('''\n",
    "WITH LargestYear AS\n",
    "(SELECT MAX(Year) as Year FROM tOrder),\n",
    "LargestMonth AS\n",
    "(SELECT MAX(Month) as month\n",
    "FROM tOrder \n",
    "WHERE year = (SELECT year FROM LargestYear)),\n",
    "BuyingCusts AS\n",
    "(SELECT *\n",
    "FROM tOrder \n",
    "WHERE year = (SELECT Year FROM LargestYear)\n",
    "    AND month = (SELECT month FROM LargestMonth)),\n",
    "NotBuyingCusts AS\n",
    "(SELECT tcust.cust_id, first, last, addr, zip\n",
    "FROM tCust\n",
    "LEFT JOIN BuyingCusts\n",
    "ON tCust.cust_id = BuyingCusts.cust_id\n",
    "WHERE BuyingCusts.cust_id IS NULL),\n",
    "totalsales AS\n",
    "(SELECT year,month, sum(qty*Unit_price) as [Sales], order_id,cust_id\n",
    "FROM tOrder\n",
    "JOIN tOrderDetail \n",
    "USING (order_id)\n",
    "JOIN tProd\n",
    "USING (Prod_id)\n",
    "GROUP BY year, month,cust_id),\n",
    "AverageSales AS\n",
    "(SELECT sum(sales)/33 as avgsales,cust_id \n",
    "FROM totalsales\n",
    "JOIN Notbuyingcusts\n",
    "USING(cust_id)\n",
    "GROUP BY (cust_id))\n",
    "SELECT cust_id,first,last,addr,zip,st,city,IFNULL(sales,0) as Sales, avgsales\n",
    "FROM NotBuyingCusts\n",
    "LEFT JOIN SalesLast\n",
    "using(cust_id)\n",
    "JOIN tZip \n",
    "USING(zip)\n",
    "JOIN AverageSales\n",
    "USING(cust_id)\n",
    "ORDER BY avgsales DESC\n",
    ";''',conn)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "25a952d1-6687-47e2-b3ea-e43051ab5630",
   "metadata": {},
   "source": [
    "---\n",
    "8) Are there any products we haven't sold at least 1 of each month?\n",
    "\n",
    "If so, return:\n",
    " \n",
    "- product id, name, and unit price\n",
    "- years and months that had no sales\n",
    "\n",
    "Order the results with the products with the largest unit price on top."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "id": "d30460af-c524-4836-b352-18b656271993",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>qty</th>\n",
       "      <th>year</th>\n",
       "      <th>month</th>\n",
       "      <th>prod_id</th>\n",
       "      <th>prod_desc</th>\n",
       "      <th>unit_price</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>None</td>\n",
       "      <td>2019</td>\n",
       "      <td>8</td>\n",
       "      <td>329</td>\n",
       "      <td>Chainsaw</td>\n",
       "      <td>499.99</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>None</td>\n",
       "      <td>2019</td>\n",
       "      <td>9</td>\n",
       "      <td>329</td>\n",
       "      <td>Chainsaw</td>\n",
       "      <td>499.99</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>None</td>\n",
       "      <td>2019</td>\n",
       "      <td>4</td>\n",
       "      <td>328</td>\n",
       "      <td>Workbench</td>\n",
       "      <td>300.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>None</td>\n",
       "      <td>2019</td>\n",
       "      <td>9</td>\n",
       "      <td>325</td>\n",
       "      <td>Toolbox</td>\n",
       "      <td>50.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>None</td>\n",
       "      <td>2019</td>\n",
       "      <td>7</td>\n",
       "      <td>325</td>\n",
       "      <td>Toolbox</td>\n",
       "      <td>50.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>5</th>\n",
       "      <td>None</td>\n",
       "      <td>2019</td>\n",
       "      <td>7</td>\n",
       "      <td>321</td>\n",
       "      <td>Axe</td>\n",
       "      <td>27.99</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>6</th>\n",
       "      <td>None</td>\n",
       "      <td>2019</td>\n",
       "      <td>4</td>\n",
       "      <td>318</td>\n",
       "      <td>Hacksaw</td>\n",
       "      <td>19.99</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>7</th>\n",
       "      <td>None</td>\n",
       "      <td>2019</td>\n",
       "      <td>9</td>\n",
       "      <td>315</td>\n",
       "      <td>Pliers</td>\n",
       "      <td>15.99</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>8</th>\n",
       "      <td>None</td>\n",
       "      <td>2019</td>\n",
       "      <td>6</td>\n",
       "      <td>314</td>\n",
       "      <td>Mallet</td>\n",
       "      <td>12.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>9</th>\n",
       "      <td>None</td>\n",
       "      <td>2019</td>\n",
       "      <td>6</td>\n",
       "      <td>313</td>\n",
       "      <td>Wrench</td>\n",
       "      <td>11.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>10</th>\n",
       "      <td>None</td>\n",
       "      <td>2019</td>\n",
       "      <td>7</td>\n",
       "      <td>312</td>\n",
       "      <td>Plane</td>\n",
       "      <td>10.99</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>11</th>\n",
       "      <td>None</td>\n",
       "      <td>2019</td>\n",
       "      <td>4</td>\n",
       "      <td>310</td>\n",
       "      <td>Scraper</td>\n",
       "      <td>7.99</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>12</th>\n",
       "      <td>None</td>\n",
       "      <td>2019</td>\n",
       "      <td>7</td>\n",
       "      <td>309</td>\n",
       "      <td>Chisel</td>\n",
       "      <td>4.99</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>13</th>\n",
       "      <td>None</td>\n",
       "      <td>2019</td>\n",
       "      <td>5</td>\n",
       "      <td>308</td>\n",
       "      <td>Screwdriver</td>\n",
       "      <td>3.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>14</th>\n",
       "      <td>None</td>\n",
       "      <td>2019</td>\n",
       "      <td>3</td>\n",
       "      <td>307</td>\n",
       "      <td>Sandpaper</td>\n",
       "      <td>3.00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>15</th>\n",
       "      <td>None</td>\n",
       "      <td>2019</td>\n",
       "      <td>9</td>\n",
       "      <td>305</td>\n",
       "      <td>Bradawl</td>\n",
       "      <td>1.99</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>16</th>\n",
       "      <td>None</td>\n",
       "      <td>2019</td>\n",
       "      <td>9</td>\n",
       "      <td>301</td>\n",
       "      <td>Nail</td>\n",
       "      <td>0.25</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>17</th>\n",
       "      <td>None</td>\n",
       "      <td>2019</td>\n",
       "      <td>9</td>\n",
       "      <td>300</td>\n",
       "      <td>Washer</td>\n",
       "      <td>0.10</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "     qty  year  month  prod_id    prod_desc  unit_price\n",
       "0   None  2019      8      329     Chainsaw      499.99\n",
       "1   None  2019      9      329     Chainsaw      499.99\n",
       "2   None  2019      4      328    Workbench      300.00\n",
       "3   None  2019      9      325      Toolbox       50.00\n",
       "4   None  2019      7      325      Toolbox       50.00\n",
       "5   None  2019      7      321          Axe       27.99\n",
       "6   None  2019      4      318      Hacksaw       19.99\n",
       "7   None  2019      9      315       Pliers       15.99\n",
       "8   None  2019      6      314       Mallet       12.00\n",
       "9   None  2019      6      313       Wrench       11.00\n",
       "10  None  2019      7      312        Plane       10.99\n",
       "11  None  2019      4      310      Scraper        7.99\n",
       "12  None  2019      7      309       Chisel        4.99\n",
       "13  None  2019      5      308  Screwdriver        3.00\n",
       "14  None  2019      3      307    Sandpaper        3.00\n",
       "15  None  2019      9      305      Bradawl        1.99\n",
       "16  None  2019      9      301         Nail        0.25\n",
       "17  None  2019      9      300       Washer        0.10"
      ]
     },
     "execution_count": 5,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "pd.read_sql('''\n",
    "WITH Months AS\n",
    "(SELECT DISTINCT(year), month\n",
    "FROM tOrder),\n",
    "allcombos AS\n",
    "(SELECT prod_id, prod_desc,month,year,unit_price\n",
    "FROM tProd\n",
    "JOIN Months),\n",
    "allorders AS\n",
    "(SELECT prod_id,sum(qty) as qty,year,month\n",
    "FROM tOrderDetail\n",
    "JOIN tOrder\n",
    "Using(order_id)\n",
    "Group BY prod_id,month,year)\n",
    "SELECT qty,year,month,prod_id, prod_desc, unit_price\n",
    "FROM allcombos\n",
    "left join allorders\n",
    "USING(prod_id,month,year)\n",
    "WHERE qty IS NULL\n",
    "ORDER BY unit_price DESC\n",
    ";''',conn)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "a41e4a52-1d08-48b7-a9e0-154f03c5a892",
   "metadata": {},
   "source": [
    "---\n",
    "9) What are our top 5 selling products (in terms of total dollars sold)?\n",
    "\n",
    "Return:\n",
    "\n",
    "- product id, name, unit_price\n",
    "- total sales (i.e. sum of qty * unit price)\n",
    "\n",
    "Order the results by total sales, descending"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "id": "2e3c5da0-c69f-4c80-8d67-23ed2c0c6cbb",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>Sales</th>\n",
       "      <th>prod_id</th>\n",
       "      <th>prod_desc</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>943481.13</td>\n",
       "      <td>329</td>\n",
       "      <td>Chainsaw</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>633300.00</td>\n",
       "      <td>328</td>\n",
       "      <td>Workbench</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>154000.00</td>\n",
       "      <td>327</td>\n",
       "      <td>Ladder</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>131652.00</td>\n",
       "      <td>326</td>\n",
       "      <td>Drill</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>100850.00</td>\n",
       "      <td>325</td>\n",
       "      <td>Toolbox</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "       Sales  prod_id  prod_desc\n",
       "0  943481.13      329   Chainsaw\n",
       "1  633300.00      328  Workbench\n",
       "2  154000.00      327     Ladder\n",
       "3  131652.00      326      Drill\n",
       "4  100850.00      325    Toolbox"
      ]
     },
     "execution_count": 7,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "pd.read_sql('''\n",
    "SELECT sum(qty*Unit_price) as [Sales], prod_id, prod_desc\n",
    "FROM tOrder\n",
    "JOIN tOrderDetail \n",
    "USING (order_id)\n",
    "JOIN tProd\n",
    "USING (Prod_id)\n",
    "GROUP BY prod_id\n",
    "ORDER BY Sales DESC\n",
    "LIMIT 5\n",
    ";''',conn)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "b78bd07a-4fd2-497f-9128-7b412af46c5e",
   "metadata": {},
   "source": [
    "---\n",
    "\n",
    "10) What month did we have our highest sales, and what was our top selling product that month? (All in terms of dollars).\n",
    "\n",
    "Return:\n",
    "\n",
    "- The month and year\n",
    "- The total sales for that month\n",
    "- The top selling product that month (product id, and name)\n",
    "- Total sales (sum of qty * unit price) for that product that month\n",
    "- Total units (total qty) for that product that month"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 138,
   "id": "8214e5a7-c982-41af-8db2-0460ae6dcee6",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>month</th>\n",
       "      <th>year</th>\n",
       "      <th>total_sales_in_month</th>\n",
       "      <th>total_sales_for_product</th>\n",
       "      <th>prod_id</th>\n",
       "      <th>prod_desc</th>\n",
       "      <th>totalSold</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>10</td>\n",
       "      <td>2021</td>\n",
       "      <td>251768.12</td>\n",
       "      <td>86998.26</td>\n",
       "      <td>329</td>\n",
       "      <td>Chainsaw</td>\n",
       "      <td>174</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "   month  year  total_sales_in_month  total_sales_for_product  prod_id  \\\n",
       "0     10  2021             251768.12                 86998.26      329   \n",
       "\n",
       "  prod_desc  totalSold  \n",
       "0  Chainsaw        174  "
      ]
     },
     "execution_count": 138,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "pd.read_sql('''\n",
    "WITH monthlySales AS\n",
    "(SELECT year,month, sum(qty*Unit_price) as [Sales]\n",
    "FROM tOrder\n",
    "JOIN tOrderDetail \n",
    "USING (order_id)\n",
    "JOIN tProd\n",
    "USING (Prod_id)\n",
    "GROUP BY year, month),\n",
    "MostSalesMonth AS\n",
    "(SELECT MAX(Sales) as Sales, Year, Month\n",
    "FROM monthlySales),\n",
    "LargestMonthSales AS\n",
    "(SELECT *, sum(qty*Unit_price) as [Sales], sum(qty) as totalSold\n",
    "FROM tOrder \n",
    "JOIN tOrderDetail \n",
    "USING (order_id)\n",
    "JOIN tProd\n",
    "USING(prod_id)\n",
    "WHERE month = (SELECT month FROM mostSalesMonth)\n",
    "    AND year = (SELECT year FROM mostSalesMonth)\n",
    "GROUP BY prod_id)\n",
    "SELECT month,year,sum(Sales) as total_sales_in_month,max(sales) as total_sales_for_product, prod_id, prod_desc, totalSold\n",
    "FROM LargestMonthSales\n",
    ";''',conn)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "f2798fe1-cf70-493f-b40e-9a29059437d5",
   "metadata": {},
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3 (ipykernel)",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.10.9"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
